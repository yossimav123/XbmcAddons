# -*- coding: utf-8 -*-"""    Plugin for streaming video content from www.sdarot.tv"""import urllib, urllib2, re, os, sys import xbmcaddon, xbmc, xbmcplugin, xbmcguiimport HTMLParserimport jsonimport cookielib##General vars        __plugin__ = "Sdarot.TV Video"__author__ = "Cubicle"__image_path__ = ''__settings__ = xbmcaddon.Addon(id='plugin.video.sdarot.tv')__language__ = __settings__.getLocalizedString__PLUGIN_PATH__ = __settings__.getAddonInfo('path')LIB_PATH = xbmc.translatePath( os.path.join( __PLUGIN_PATH__, 'resources', 'lib' ) )sys.path.append (LIB_PATH)_USER_AGENT_ = 'Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.31 (KHTML, like Gecko) Chrome/26.0.1410.64 Safari/537.31'from sdarotcommon import *def MAIN_MENU():    addDir("הכל א-ת","all-heb",2,'');    addDir("הכל a-z","all-eng",2,'');    addDir("מועדפים","all-eng",3,'');def message(title, message):    dialog = xbmcgui.Dialog()    dialog.ok(title , message)    def INDEX_AZ(url):    page = getData('http://www.sdarot.tv/series');    #print page    matches = re.compile('<a href="/watch/(\d+)-(.*?)">.*?</noscript>.*?<div>(.*?)</div>').findall(page)    sr_arr = []    idx = 0    i=0    if url == "all-eng":      idx = 1    for match in matches:      series_id = match[0]      link_name = match[1]      name = HTMLParser.HTMLParser().unescape(match[2])      m_arr = name.split(" / ")      if (len(m_arr)>1) and (idx==1):        sr_arr.append(( series_id, link_name, m_arr[1].strip() ))      else:        sr_arr.append(( series_id, link_name, m_arr[0].strip() ))      i=i+1    sr_sorted = sorted(sr_arr,key=lambda sr_arr: sr_arr[2])          for key in sr_sorted:      series_link="http://www.sdarot.tv/watch/"+str(key[0])+"/"+key[1]      image_link="http://www.sdarot.tv/media/series/"+str(key[0])+".jpg"            addDir(key[2],series_link,"3&image="+urllib.quote(image_link)+"&series_id="+str(key[0])+"&series_name="+urllib.quote(key[1]),image_link)    xbmcplugin.setContent(int(sys.argv[1]), 'tvshows')      def sdarot_series(url):    #url = url.encode("UTF-8")    series_id=urllib.unquote_plus(params["series_id"])    series_name=urllib.unquote_plus(params["series_name"])    image_link=urllib.unquote_plus(params["image"])    cj = cookielib.CookieJar()    opener = urllib2.build_opener(urllib2.HTTPCookieProcessor(cj))##    opener.addheaders = [('Referer',url),##      ('User-Agent', _USER_AGENT_) ]    opener.addheaders = [('User-Agent', _USER_AGENT_) ]    #print urllib.urlencode(url)    #opener.open('http://www.sdarot.tv/landing/'+series_id).read()    print "sdarot_series: Fetching URL:"+url      page = opener.open(url).read()##    try:##    except urllib2.URLError, e:##        print 'sdarot_season: got http error ' +str(e.code) + ' fetching ' + url + "\n"##        raise e    #page = getData(url);    #print "Page Follows:\n"    #print page                 #<ul id="season">    block_regexp='id="season">(.*?)</ul>'    seasons_list = re.compile(block_regexp,re.I+re.M+re.U+re.S).findall(page)[0]    regexp='>(\d+)</a'    matches = re.compile(regexp).findall(seasons_list)    for season in matches:        addDir("עונה "+ str(season),url,"5&image="+urllib.quote(image_link)+"&season_id="+str(season)+"&series_id="+str(series_id)+"&series_name="+urllib.quote(series_id),image_link)    xbmcplugin.setContent(int(sys.argv[1]), 'tvshows')      def sdarot_season(url):    series_id=urllib.unquote_plus(params["series_id"])    series_name=urllib.unquote_plus(params["series_name"])    season_id=urllib.unquote_plus(params["season_id"])    image_link=urllib.unquote_plus(params["image"])    page = getData(url="http://www.sdarot.tv/ajax/watch",timeout=0,postData="eplist=true&serie="+series_id+"&season="+season_id);    #print page    episodes=page.split(",")    for episode in episodes:      if ( episode.find("-") != -1 ):        episode=episode.replace("-0","")      addVideoLink("פרק "+str(episode), url, "4&episode_id="+str(episode)+"&image="+urllib.quote(image_link)+"&season_id="+str(season_id)+"&series_id="+str(series_id)+"&series_name="+urllib.quote(series_id),image_link, '')          xbmcplugin.setContent(int(sys.argv[1]), 'episodes')def sdarot_movie(url):    series_id=urllib.unquote_plus(params["series_id"])    series_name=urllib.unquote_plus(params["series_name"])    season_id=urllib.unquote_plus(params["season_id"])    image_link=urllib.unquote_plus(params["image"])    episode_id=urllib.unquote_plus(params["episode_id"])    url_ref = urllib.unquote_plus(params["url"])    title = series_name + "עונה " + season_id + " פרק" + episode_id    #print "watch=true&serie="+series_id+"&season="+season_id+"&episode="+episode_id    #print params    #login    #getData(url='http://nht-3.extreme-dm.com/n4.g?login=sdarot&url=http%3A//www.sdarot.tv/watch/421-galis-%25D7%2592%25D7%2590%25D7%259C%25D7%2599%25D7%25A1&jv=true&d=1920x1080&c=32&l=http%3A//www.sdarot.tv/')        #page = getData(url="http://www.sdarot.tv/ajax/watch",timeout=0,postData="watch=false&serie="+series_id+"&season="+season_id+"&episode="+episode_id)    from StringIO import StringIO    import gzip    request = urllib2.Request("http://www.sdarot.tv/ajax/watch")    request.add_header('Accept-encoding', 'gzip')    request.add_header('User-Agent','Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/28.0.1500.72 Safari/537.36')    request.add_header('referer',url_ref)    #request.add_header('Cookie', '__jwpusr=6b4dccd4-3a66-408f-acef-0d77397be970')    request.add_header('Cookie', '__jwpusr=6b4dccd4-3a66-408f-acef-0d77397be970; __utma=113977925.966718929.1373655202.1373738404.1373743142.3; __utmz=113977925.1373655202.1.1.utmcsr=(direct)|utmccn=(direct)|utmcmd=(none); __utmv=113977925.|1=pubid=pub_38410=1; Sdarot=5usabjkthkv9c5ca26vvilom92; fbm_547287815322010=base_domain=.sdarot.tv; PHPSESSID=4lae01ln7tileu3i8kvr97pom2; FoxWebMediaPOPUnder=1; fbsr_547287815322010=dzGrmLHEb0Lnx1v7rzBZMVUsQPQN9qcGR-N4amHs0-E.eyJhbGdvcml0aG0iOiJITUFDLVNIQTI1NiIsImNvZGUiOiJBUURBOG92YUJERkwxanJUdUNpSFM3NUtVRUdObUJ5YUt5UlE3bThkdWc2TGFTU3U5dlNZZ21aYkdYWk16cmlmTGttdGM5amdZWVVDNk54YXFjVndUN1ZSWWpMdXJnTnlIcEpsSHBWaFhqbFRSVUFfX0Z6a0g4YWg5V2FObWdQc3hCSFUzcjJwWEN3c0pDMFVqcTN5Vlp1aHpYdkRzV2ZQT24xZ2lIdEw2MXp5c0hkTzJRS0FVeG5JWURGUGxEZkgzWF9Dcmk3Nk9ZaW9BTWhxczJPYWZ3YzA3bExqZV80UUdtWndId3RVUTNZNk5ueUw0dnN4bFd6MjRqWGhSZ0wyLUNSRWZ0enpYcDZYeEJBSDV0dkV1Q3lLazd2dzZia0RVRndBUk5mQTdYU3ZDZmxYNzNMazc0cnhqODFLNkdtTURpbyIsImlzc3VlZF9hdCI6MTM3NDI1MjgyNywidXNlcl9pZCI6IjgxOTg2MDI3NyJ9')    response = urllib2.urlopen(request,timeout=10,data="watch=true&serie="+series_id+"&season="+season_id+"&episode="+episode_id)    if response.info().get('Content-Encoding') == 'gzip':        #print 'gzip'        buf = StringIO( response.read())        f = gzip.GzipFile(fileobj=buf)        page = f.read()    #print "JSON: "    #print page    prms=json.loads(page)    print "Token: "+str(prms["token"])+"\n"    print "Time: "+str(prms["time"])+"\n"    print "VID: "+str(prms["VID"])+"\n"    token = str(prms["token"])    vid_time = str(prms["time"])    VID = str(prms["VID"])        #player_url='http://www.sdarot.tv/templates/frontend/green_w/player.swf?file='+url+'&provider=http&fullscreen=true'    player_url='http://www.sdarot.tv/templates/frontend/blue_html5/player/jwplayer.flash.swf'    #flv_url = "http://media.sdarot.tv/media/videos/sd/"+VID+'.mp4?token='+token+'&time='+vid_time+'|User-Agent='+urllib.quote(_USER_AGENT_)+'&Referer='+urllib.quote(player_url)        flv_url = "http://media.sdarot.tv/media/videos/sd/"+VID+'.mp4?token='+token+'&time='+vid_time    liz = xbmcgui.ListItem(title, path=flv_url, iconImage=params["image"], thumbnailImage=params["image"])    liz.setInfo(type="Video", infoLabels={ "Title": title })        liz.setProperty('IsPlayable', 'true')    xbmcplugin.setResolvedUrl(handle=int(sys.argv[1]), succeeded=True, listitem=liz)    ok = xbmcplugin.addDirectoryItem(handle=int(sys.argv[1]), url=flv_url, listitem=liz, isFolder=False)    params = getParams(sys.argv[2])url=Nonename=Nonemode=Nonemodule=Nonepage=Nonetry:        url=urllib.unquote_plus(params["url"])except:        passtry:        name=urllib.unquote_plus(params["name"])except:        passtry:        mode=int(params["mode"])except:        passtry:        module=urllib.unquote_plus(params["module"])except:        passtry:        page=urllib.unquote_plus(params["page"])except:        pass    if mode==None or url==None or len(url)<1:    MAIN_MENU()elif mode==2:    INDEX_AZ(url)elif mode==3:    sdarot_series(url)elif mode==4:    sdarot_movie(url)elif mode==5:    sdarot_season(url)xbmcplugin.setPluginFanart(int(sys.argv[1]),xbmc.translatePath( os.path.join( __PLUGIN_PATH__,"fanart.jpg") ))xbmcplugin.endOfDirectory(int(sys.argv[1]),cacheToDisc=0)